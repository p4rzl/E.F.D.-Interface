{% extends "layout.html" %}

{% block title %}Pannello Amministratore{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <section class="welcome-section">
        <h1>Pannello di Amministrazione</h1>
        <p>Gestisci gli utenti e i loro permessi nel sistema</p>
    </section>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Statistiche -->
    <div class="admin-stats">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-value">{{ users|length }}</div>
            <div class="stat-label">Totale Utenti</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
            <div class="stat-value">{{ users|selectattr('is_admin', 'eq', True)|list|length }}</div>
            <div class="stat-label">Amministratori</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user-slash"></i></div>
            <div class="stat-value">{{ users|selectattr('is_active', 'eq', False)|list|length }}</div>
            <div class="stat-label">Utenti Inattivi</div>
        </div>
    </div>

    <section class="admin-panel">
        <h2><i class="fas fa-users-cog"></i> Gestione Utenti</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Utente</th>
                        <th>Stato</th>
                        <th>Ruolo</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="{{ 'current-user' if user == current_user }} {{ 'user-row-locked' if not user.is_active }}">
                        <td class="user-cell">
                            <img src="{{ url_for('static', filename='img/avatars/' + user.avatar_id|string + '.png') }}" 
                                alt="Avatar" 
                                class="user-avatar">
                            <div class="user-info-admin">
                                <span class="username">{{ user.username }}</span>
                                <div>
                                    {% if user.username == 'admin' %}
                                        <span class="admin-badge">Admin Principale</span>
                                    {% endif %}
                                    {% if user == current_user %}
                                        <span class="current-user-badge">Tu</span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="status-cell">
                            <span class="status-badge {{ 'active' if user.is_active else 'inactive' }}">
                                {{ "Attivo" if user.is_active else "Disattivo" }}
                            </span>
                        </td>
                        <td class="role-cell">
                            <span class="role-badge {{ 'admin' if user.is_admin else 'user' }}">
                                {{ "Admin" if user.is_admin else "Utente" }}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <form method="POST" action="{{ url_for('toggle_user', user_id=user.id) }}" class="inline-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn-toggle" 
                                            {{ 'disabled' if user == current_user or user.username == 'admin' }}>
                                        <i class="fas {{ 'fa-user-slash' if user.is_active else 'fa-user-check' }}"></i>
                                        {{ "Disattiva" if user.is_active else "Attiva" }}
                                    </button>
                                </form>
                                
                                <form method="POST" action="{{ url_for('toggle_admin', user_id=user.id) }}" class="inline-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn-admin" 
                                            {{ 'disabled' if user == current_user or user.username == 'admin' }}>
                                        <i class="fas {{ 'fa-user-minus' if user.is_admin else 'fa-user-plus' }}"></i>
                                        {{ "Rimuovi Admin" if user.is_admin else "Rendi Admin" }}
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    
    <section class="admin-actions">
        <h2><i class="fas fa-cogs"></i> Azioni di Manutenzione</h2>
        
        <div class="action-cards">
            <div class="action-card">
                <h3><i class="fas fa-trash"></i> Pulizia Messaggi</h3>
                
                <form action="{{ url_for('admin_cleanup_messages') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="action-button">
                        <i class="fas fa-broom"></i> Pulisci Messaggi Vecchi (3+ giorni)
                    </button>
                </form>
                
                <form action="{{ url_for('admin_delete_all_messages') }}" method="post" 
                      onsubmit="return confirm('Sei sicuro di voler eliminare TUTTI i messaggi? Questa azione non puÃ² essere annullata.');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="action-button danger-button">
                        <i class="fas fa-trash-alt"></i> Elimina Tutti i Messaggi
                    </button>
                </form>
            </div>
        </div>
    </section>
</div>
{% endblock %}