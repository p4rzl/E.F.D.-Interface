{% extends "layout.html" %}

{% block title %}{{ t.chat }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- SIDEBAR SINISTRA: ELENCO DELLE CHAT DISPONIBILI -->
    <div class="chat-sidebar-left">
        <h3 class="sidebar-title">{{ t.available_chats }}</h3>
        
        <!-- Chat generale (sempre disponibile) -->
        <div class="chat-item active" data-chat-id="general" data-chat-type="general">
            <div class="general-chat-avatar">
                <i class="fas fa-comments"></i>
            </div>
            <div class="chat-info">
                <div class="chat-name">{{ t.general_chat }}</div>
                <div class="chat-last-message">{{ t.general_chat_description }}</div>
            </div>
        </div>
        
        <!-- Titolo sezione chat private -->
        <div class="chat-section-title">
            <i class="fas fa-user-friends"></i> {{ t.private_chats }}
        </div>
        
        <!-- Chat private -->
        <div class="private-chats-list">
            {% for user in users %}
                {% if user.id != current_user.id %}
                <div class="chat-item" data-chat-id="private-{{ user.id }}" data-chat-type="private" data-user-id="{{ user.id }}" data-avatar-id="{{ user.avatar_id }}">
                    <div class="user-avatar">
                        <img src="{{ url_for('static', filename='img/avatars/' ~ user.avatar_id ~ '.png') }}" alt="Avatar">
                        <span class="status-indicator {{ 'online' if user.is_online else 'offline' }}"></span>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">{{ user.username }}</div>
                        <div class="chat-last-message">
                            <span class="status-text {{ 'online-text' if user.is_online else 'offline-text' }}">
                                {{ t.online if user.is_online else t.offline }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Titolo sezione chat di gruppo -->
        <div class="chat-section-title">
            <i class="fas fa-users"></i> {{ t.group_chats }}
            <button class="btn-small-create-group" id="btnSmallCreateGroup" title="{{ t.create_group }}">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <!-- Chat di gruppo -->
        <div class="group-chats-list">
            {% if groups is defined %}
                {% for group in groups %}
                <div class="chat-item" data-chat-id="group-{{ group.id }}" data-chat-type="group" data-group-id="{{ group.id }}">
                    <div class="group-chat-avatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">{{ group.name }}</div>
                        <div class="chat-last-message">{{ group.description|truncate(30) }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-groups-message">{{ t.no_groups_available }}</div>
            {% endif %}
        </div>
    </div>
    
    <!-- AREA CENTRALE: MESSAGGI DELLA CHAT SELEZIONATA -->
    <div class="chat-main">
        <!-- Header della chat corrente -->
        <div class="chat-header">
            <div class="current-chat-info">
                <div class="current-chat-avatar" id="currentChatAvatar">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="current-chat-details">
                    <div class="current-chat-name" id="currentChatName">{{ t.general_chat }}</div>
                    <div class="current-chat-status" id="currentChatStatus">{{ t.general_chat_description }}</div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="btn-chat-info" id="btnChatInfo" title="{{ t.chat_info }}">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>
        
        <!-- Area messaggi -->
        <div class="chat-messages" id="chatMessages">
            <!-- Messaggi iniziali -->
            {% for message in messages %}
                <div class="message {{ 'message-own' if message.sender_id == current_user.id else '' }}" id="msg-{{ message.id }}">
                    <div class="message-avatar">
                        <img src="{{ url_for('static', filename='img/avatars/' ~ message.sender.avatar_id ~ '.png') }}" alt="Avatar">
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-username">{{ message.sender.username }}</span>
                            <span class="message-time">{{ message.timestamp.strftime('%H:%M') }}</span>
                        </div>
                        <div class="message-text">{{ message.text }}</div>
                    </div>
                </div>
            {% endfor %}
            
            <!-- Messaggio iniziale se non ci sono messaggi -->
            {% if messages|length == 0 %}
                <div class="system-message">
                    {{ t.welcome_to_general_chat }}
                </div>
            {% endif %}
        </div>
        
        <!-- Area input per scrivere messaggi -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" id="chat-input" class="chat-input" placeholder="{{ t.type_message }}...">
                <button id="send-button" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- SIDEBAR DESTRA: PARTECIPANTI ALLA CHAT CORRENTE -->
    <div class="chat-sidebar-right">
        <!-- Header della sidebar -->
        <div class="sidebar-header">
            <h3>{{ t.chat_participants }}</h3>
        </div>
        
        <!-- Lista utenti online/offline nella chat corrente -->
        <div class="online-users" id="onlineUsers">
            <!-- Utenti online -->
            <div class="user-category-title">{{ t.online }}</div>
            <div class="online-users-list">
                {% for user in users %}
                    {% if user.is_online %}
                    <div class="online-user-item" data-user-id="{{ user.id }}">
                        <div class="user-avatar">
                            <img src="{{ url_for('static', filename='img/avatars/' ~ user.avatar_id ~ '.png') }}" alt="Avatar">
                            <span class="status-indicator online"></span>
                        </div>
                        <div class="user-info">
                            <span class="user-name">{{ user.username }}</span>
                            {% if user.is_admin %}
                            <span class="admin-badge"><i class="fas fa-shield-alt"></i> {{ t.admin }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <!-- Utenti offline -->
            <div class="user-category-title">{{ t.offline }}</div>
            <div class="offline-users-list">
                {% for user in users %}
                    {% if not user.is_online %}
                    <div class="online-user-item offline" data-user-id="{{ user.id }}">
                        <div class="user-avatar">
                            <img src="{{ url_for('static', filename='img/avatars/' ~ user.avatar_id ~ '.png') }}" alt="Avatar">
                            <span class="status-indicator offline"></span>
                        </div>
                        <div class="user-info">
                            <span class="user-name">{{ user.username }}</span>
                            {% if user.is_admin %}
                            <span class="admin-badge"><i class="fas fa-shield-alt"></i> {{ t.admin }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- MODALI -->
<!-- Modal creazione gruppo -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t.create_group }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">{{ t.group_name }}</label>
                        <input type="text" class="form-control" id="groupName" required>
                    </div>
                    <div class="mb-3">
                        <label for="groupDescription" class="form-label">{{ t.group_description }}</label>
                        <textarea class="form-control" id="groupDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ t.add_members }}</label>
                        <div class="user-selection">
                            {% for user in users %}
                                {% if user.id != current_user.id %}
                                <div class="user-select-item">
                                    <input type="checkbox" class="form-check-input" id="user-{{ user.id }}" value="{{ user.id }}">
                                    <label for="user-{{ user.id }}" class="form-check-label">
                                        <img src="{{ url_for('static', filename='img/avatars/' ~ user.avatar_id ~ '.png') }}" alt="Avatar" class="user-select-avatar">
                                        {{ user.username }}
                                    </label>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.cancel }}</button>
                <button type="button" class="btn btn-primary" id="createGroupBtn">{{ t.create }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal info chat -->
<div class="modal fade" id="chatInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t.chat_info }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="chatInfoContent">
                <!-- Contenuto dinamico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.close }}</button>
                <button type="button" class="btn btn-danger" id="leaveGroupBtn" style="display: none;">{{ t.leave_group }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Suono notifica messaggi -->
<audio id="message-sound" preload="auto">
    <source src="{{ url_for('static', filename='audio/message.mp3') }}" type="audio/mpeg">
</audio>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
<script>
    // Configurazione iniziale
    let currentChat = {
        id: 'general',
        type: 'general',
        name: '{{ t.general_chat }}',
        targetId: null
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        const messageSound = document.getElementById('message-sound');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.getElementById('chatMessages');
        const createGroupModal = new bootstrap.Modal(document.getElementById('createGroupModal'));
        const chatInfoModal = new bootstrap.Modal(document.getElementById('chatInfoModal'));
        
        // Funzione per inviare un messaggio
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                socket.emit('message', {
                    message: message,
                    chatType: currentChat.type,
                    targetId: currentChat.targetId
                });
                chatInput.value = '';
                chatInput.focus();
            }
        }
        
        // Event listeners per l'invio dei messaggi
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Connessione socket
        socket.on('connect', function() {
            console.log('Connesso al server chat');
            loadChatMessages(); // Carica i messaggi della chat generale all'avvio
        });
        
        // Ricezione di un nuovo messaggio
        socket.on('message', function(data) {
            if (shouldDisplayMessage(data)) {
                addMessageToChat(data);
                // Riproduci suono solo se il messaggio non è tuo
                if (!data.is_own && !document.hidden) {
                    messageSound.play().catch(e => console.log('Impossibile riprodurre il suono:', e));
                }
            }
        });
        
        // Aggiorna lo stato online/offline degli utenti
        socket.on('user_status', function(data) {
            updateUserStatus(data.username, data.status);
        });
        
        // Click su una chat nella sidebar
        document.querySelectorAll('.chat-item').forEach(item => {
            item.addEventListener('click', function() {
                // Rimuovi classe active da tutte le chat
                document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
                // Aggiungi classe active alla chat cliccata
                this.classList.add('active');
                
                // Salva informazioni sulla chat corrente
                const chatId = this.getAttribute('data-chat-id');
                const chatType = this.getAttribute('data-chat-type');
                let targetId = null;
                
                if (chatType === 'private') {
                    targetId = parseInt(this.getAttribute('data-user-id'));
                } else if (chatType === 'group') {
                    targetId = parseInt(this.getAttribute('data-group-id'));
                }
                
                // Aggiorna lo stato della chat corrente
                currentChat = {
                    id: chatId,
                    type: chatType,
                    name: this.querySelector('.chat-name').textContent,
                    targetId: targetId
                };
                
                // Aggiorna l'header della chat
                updateChatHeader();
                
                // Carica i messaggi per questa chat
                loadChatMessages();
                
                // Aggiorna la lista dei partecipanti nella sidebar destra
                updateChatParticipants();
            });
        });
        
        // Pulsante creazione gruppo (sia nel tab che nel pulsante piccolo)
        document.getElementById('btnSmallCreateGroup').addEventListener('click', function() {
            createGroupModal.show();
        });
        
        document.getElementById('createGroupBtn').addEventListener('click', function() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            const selectedUsers = Array.from(document.querySelectorAll('.user-selection input:checked')).map(input => parseInt(input.value));
            
            if (groupName) {
                socket.emit('create_group', {
                    name: groupName,
                    description: groupDescription,
                    members: selectedUsers
                });
                createGroupModal.hide();
                
                // Reset form
                document.getElementById('createGroupForm').reset();
            }
        });
        
        // Pulsante info chat
        document.getElementById('btnChatInfo').addEventListener('click', function() {
            loadChatInfo();
            chatInfoModal.show();
        });
        
        // Funzione per aggiungere un messaggio alla chat
        function addMessageToChat(data) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if (data.is_own) {
                messageElement.classList.add('message-own');
            }
            messageElement.id = data.id;
            
            messageElement.innerHTML = `
                <div class="message-avatar">
                    <img src="/static/img/avatars/${data.avatar_id}.png" alt="Avatar">
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username">${data.user}</span>
                        <span class="message-time">${data.time}</span>
                    </div>
                    <div class="message-text">${data.message}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            // Scroll alla fine
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Funzione per caricare i messaggi di una chat
        function loadChatMessages() {
            // Pulisci i messaggi esistenti
            chatMessages.innerHTML = '';
            
            // Richiedi i messaggi al server
            socket.emit('get_messages', {
                chatType: currentChat.type,
                targetId: currentChat.targetId
            });
        }
        
        // Funzione per aggiornare l'header della chat
        function updateChatHeader() {
            const chatName = document.getElementById('currentChatName');
            const chatStatus = document.getElementById('currentChatStatus');
            const chatAvatar = document.getElementById('currentChatAvatar');
            
            chatName.textContent = currentChat.name;
            
            if (currentChat.type === 'general') {
                chatAvatar.innerHTML = '<i class="fas fa-comments"></i>';
                chatStatus.textContent = '{{ t.general_chat_description }}';
            } 
            else if (currentChat.type === 'private') {
                const userId = currentChat.targetId;
                const userItem = document.querySelector(`.chat-item[data-user-id="${userId}"]`);
                if (userItem) {
                    const isOnline = userItem.querySelector('.status-indicator').classList.contains('online');
                    chatAvatar.innerHTML = `<img src="/static/img/avatars/${userItem.getAttribute('data-avatar-id') || '1'}.png" alt="Avatar">`;
                    chatStatus.textContent = isOnline ? '{{ t.online }}' : '{{ t.offline }}';
                    chatStatus.className = 'current-chat-status ' + (isOnline ? 'online-text' : 'offline-text');
                }
            }
            else if (currentChat.type === 'group') {
                chatAvatar.innerHTML = '<i class="fas fa-users"></i>';
                // Trova le info del gruppo
                const groupItem = document.querySelector(`.chat-item[data-group-id="${currentChat.targetId}"]`);
                if (groupItem) {
                    const description = groupItem.querySelector('.chat-last-message').textContent;
                    chatStatus.textContent = description;
                    chatStatus.className = 'current-chat-status';
                }
            }
        }
        
        // Funzione per aggiornare la lista dei partecipanti nella sidebar destra
        function updateChatParticipants() {
            const onlineUsersContainer = document.getElementById('onlineUsers');
            
            // Richiedi al server la lista dei partecipanti
            socket.emit('get_chat_participants', {
                chatType: currentChat.type,
                targetId: currentChat.targetId
            });
            
            // Il server risponderà con l'evento 'chat_participants'
            socket.once('chat_participants', function(data) {
                // Aggiorna la sidebar destra con i partecipanti
                onlineUsersContainer.innerHTML = '';
                
                if (data.online && data.online.length > 0) {
                    const onlineTitle = document.createElement('div');
                    onlineTitle.classList.add('user-category-title');
                    onlineTitle.textContent = '{{ t.online }}';
                    onlineUsersContainer.appendChild(onlineTitle);
                    
                    const onlineList = document.createElement('div');
                    onlineList.classList.add('online-users-list');
                    
                    data.online.forEach(user => {
                        const userItem = createUserElement(user, true);
                        onlineList.appendChild(userItem);
                    });
                    
                    onlineUsersContainer.appendChild(onlineList);
                }
                
                if (data.offline && data.offline.length > 0) {
                    const offlineTitle = document.createElement('div');
                    offlineTitle.classList.add('user-category-title');
                    offlineTitle.textContent = '{{ t.offline }}';
                    onlineUsersContainer.appendChild(offlineTitle);
                    
                    const offlineList = document.createElement('div');
                    offlineList.classList.add('offline-users-list');
                    
                    data.offline.forEach(user => {
                        const userItem = createUserElement(user, false);
                        offlineList.appendChild(userItem);
                    });
                    
                    onlineUsersContainer.appendChild(offlineList);
                }
            });
        }
        
        // Funzione per creare elemento utente
        function createUserElement(user, isOnline) {
            const userElement = document.createElement('div');
            userElement.classList.add('online-user-item');
            if (!isOnline) {
                userElement.classList.add('offline');
            }
            userElement.setAttribute('data-user-id', user.id);
            
            userElement.innerHTML = `
                <div class="user-avatar">
                    <img src="/static/img/avatars/${user.avatar_id}.png" alt="Avatar">
                    <span class="status-indicator ${isOnline ? 'online' : 'offline'}"></span>
                </div>
                <div class="user-info">
                    <span class="user-name">${user.username}</span>
                    ${user.is_admin ? '<span class="admin-badge"><i class="fas fa-shield-alt"></i> {{ t.admin }}</span>' : ''}
                </div>
            `;
            
            return userElement;
        }
        
        // Funzione per verificare se un messaggio deve essere visualizzato
        function shouldDisplayMessage(data) {
            if (currentChat.type === 'general' && (!data.chatType || data.chatType === 'general')) {
                return true;
            }
            
            if (currentChat.type === 'private' && data.chatType === 'private') {
                if (data.fromUserId === currentChat.targetId || data.toUserId === currentChat.targetId) {
                    return true;
                }
            }
            
            if (currentChat.type === 'group' && data.chatType === 'group' && data.groupId === currentChat.targetId) {
                return true;
            }
            
            return false;
        }
        
        // Funzione per caricare le informazioni sulla chat
        function loadChatInfo() {
            const infoContent = document.getElementById('chatInfoContent');
            const leaveGroupBtn = document.getElementById('leaveGroupBtn');
            
            if (currentChat.type === 'general') {
                infoContent.innerHTML = `
                    <div class="chat-info-content">
                        <h4>${currentChat.name}</h4>
                        <p>{{ t.general_chat_description }}</p>
                        <div class="info-section">
                            <h5>{{ t.participants }}</h5>
                            <p>{{ t.all_users_participate }}</p>
                        </div>
                    </div>
                `;
                leaveGroupBtn.style.display = 'none';
            }
            else if (currentChat.type === 'private') {
                const userId = currentChat.targetId;
                const userItem = document.querySelector(`.chat-item[data-user-id="${userId}"]`);
                
                if (userItem) {
                    const userName = userItem.querySelector('.chat-name').textContent;
                    const avatarId = userItem.getAttribute('data-avatar-id') || '1';
                    const isOnline = userItem.querySelector('.status-indicator').classList.contains('online');
                    
                    infoContent.innerHTML = `
                        <div class="chat-info-content">
                            <div class="user-profile">
                                <img src="/static/img/avatars/${avatarId}.png" alt="Avatar" class="profile-avatar">
                                <h4>${userName}</h4>
                                <span class="status ${isOnline ? 'online' : 'offline'}">
                                    ${isOnline ? '{{ t.online }}' : '{{ t.offline }}'}
                                </span>
                            </div>
                            <div class="info-section">
                                <h5>{{ t.private_chat }}</h5>
                                <p>{{ t.private_chat_description }}</p>
                            </div>
                        </div>
                    `;
                    leaveGroupBtn.style.display = 'none';
                }
            }
            else if (currentChat.type === 'group') {
                socket.emit('get_group_info', {
                    group_id: currentChat.targetId
                });
                
                socket.once('group_info', function(groupInfo) {
                    infoContent.innerHTML = `
                        <div class="chat-info-content">
                            <h4>${groupInfo.name}</h4>
                            <p>${groupInfo.description || '{{ t.no_description }}'}</p>
                            <div class="info-section">
                                <h5>{{ t.created_by }}</h5>
                                <p>${groupInfo.creator_name}</p>
                            </div>
                            <div class="info-section">
                                <h5>{{ t.created_at }}</h5>
                                <p>${new Date(groupInfo.created_at).toLocaleDateString()}</p>
                            </div>
                            <div class="info-section">
                                <h5>{{ t.members }} (${groupInfo.members.length})</h5>
                                <ul class="members-list">
                                    ${groupInfo.members.map(member => `
                                        <li>
                                            <img src="/static/img/avatars/${member.avatar_id}.png" alt="Avatar" class="member-avatar">
                                            ${member.username}
                                            ${member.is_admin ? '<span class="admin-badge small"><i class="fas fa-shield-alt"></i></span>' : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    // Mostra il pulsante di uscita dal gruppo solo se l'utente è membro
                    const userIsMember = groupInfo.members.some(member => member.id === {{ current_user.id }});
                    leaveGroupBtn.style.display = userIsMember ? 'block' : 'none';
                });
            }
        }
        
        // Funzione per aggiornare lo stato di un utente
        function updateUserStatus(username, isOnline) {
            // Aggiorna nella lista chat
            document.querySelectorAll('.chat-item').forEach(item => {
                const chatName = item.querySelector('.chat-name').textContent;
                if (chatName === username) {
                    const statusIndicator = item.querySelector('.status-indicator');
                    if (statusIndicator) {
                        statusIndicator.className = `status-indicator ${isOnline ? 'online' : 'offline'}`;
                    }
                    
                    const chatStatus = item.querySelector('.chat-last-message .status-text');
                    if (chatStatus) {
                        chatStatus.textContent = isOnline ? '{{ t.online }}' : '{{ t.offline }}';
                        chatStatus.className = `status-text ${isOnline ? 'online-text' : 'offline-text'}`;
                    }
                    
                    // Se è la chat correntemente aperta, aggiorna anche l'header
                    if (currentChat.type === 'private' && currentChat.name === username) {
                        const currentChatStatus = document.getElementById('currentChatStatus');
                        currentChatStatus.textContent = isOnline ? '{{ t.online }}' : '{{ t.offline }}';
                        currentChatStatus.className = 'current-chat-status ' + (isOnline ? 'online-text' : 'offline-text');
                    }
                }
            });
            
            // Aggiorna nella lista partecipanti
            document.querySelectorAll('.online-user-item').forEach(item => {
                const userName = item.querySelector('.user-name').textContent;
                if (userName === username) {
                    const statusIndicator = item.querySelector('.status-indicator');
                    if (statusIndicator) {
                        statusIndicator.className = `status-indicator ${isOnline ? 'online' : 'offline'}`;
                    }
                }
            });
        }
    });
</script>
{% endblock %}
